<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Menu Duel</title>
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <style>
      /* Reuse theme from game.html */
      :root {
        --bg-primary: #833ab4;
        --bg-gradient: linear-gradient(
          67deg,
          rgba(131, 58, 180, 1) 0%,
          rgba(253, 62, 38, 1) 59%,
          rgba(252, 176, 69, 1) 100%
        );
        --text-primary: #000000;
        --card-bg: #ffffff;
        --border-color: #000000;
        --shadow-color: #000000;
        --accent-orange: #ff6b35;
        --accent-teal: #4ecdc4;
        --border-radius: 0px;
      }

      body {
        font-family: "Inter", -apple-system, BlinkMacSystemFont, "Segoe UI",
          Roboto, Oxygen, Ubuntu, Cantarell, "Open Sans", "Helvetica Neue",
          sans-serif;
        margin: 0;
        padding: 0;
        background: var(--bg-gradient);
        color: var(--text-primary);
      }

      .container {
        max-width: 900px;
        margin: 0 auto;
        padding: 2rem;
      }

      h1 {
        text-align: center;
        font-weight: 900;
        font-size: 2.2rem;
        text-shadow: 4px 4px 0px var(--accent-teal);
      }

      .panel {
        background: var(--card-bg);
        border: 3px solid var(--border-color);
        padding: 1rem 1.5rem;
        box-shadow: 6px 6px 0px var(--shadow-color);
        margin: 1rem 0;
      }

      .row {
        display: flex;
        flex-wrap: wrap;
        gap: 1rem;
        align-items: center;
      }

      .score {
        background: var(--accent-orange);
        border: 3px solid var(--border-color);
        padding: 0.75rem 1rem;
        font-weight: 900;
        text-transform: uppercase;
        box-shadow: 5px 5px 0 var(--shadow-color);
        display: inline-block;
      }

      .btn {
        background: var(--accent-teal);
        border: 3px solid var(--border-color);
        padding: 0.75rem 1rem;
        font-weight: 900;
        text-transform: uppercase;
        cursor: pointer;
        box-shadow: 5px 5px 0 var(--shadow-color);
      }

      .options {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
        gap: 1rem;
      }

      .option-button,
      .image-option {
        border: 4px solid var(--border-color);
        background: var(--card-bg);
        cursor: pointer;
        box-shadow: 8px 8px 0px var(--accent-orange);
        transition: transform 0.2s ease;
      }

      .option-button {
        padding: 1rem 1.25rem;
        font-weight: 900;
        text-transform: uppercase;
      }

      .image-option img {
        width: 100%;
        height: 180px;
        object-fit: cover;
        display: block;
      }

      .message {
        margin-top: 1rem;
        padding: 1rem;
        border: 3px solid var(--border-color);
        font-weight: 900;
        text-transform: uppercase;
        text-align: center;
      }
    </style>
  </head>
  <body>
    <div class="container">
      <h1>Menu Duel</h1>

      <div class="panel" id="lobby">
        <div class="row">
          <button class="btn" id="create-btn">Create Duel</button>
          <input
            class="panel"
            id="invite-link"
            readonly
            placeholder="Invite link will appear here"
            style="flex: 1; min-width: 300px"
          />
          <button class="btn" id="copy-link">Copy Link</button>
        </div>
        <div class="row" style="margin-top: 0.5rem">
          <input
            class="panel"
            id="duel-id-input"
            placeholder="Enter Duel ID to join"
          />
          <button class="btn" id="join-btn">Join</button>
        </div>
      </div>

      <div class="panel" id="status" style="display: none"></div>

      <div class="panel" id="hud" style="display: none">
        <div class="row">
          <div class="score">
            Me: <span id="me-name"></span> (<span id="me-score">0</span>)
          </div>
          <div class="score">
            Opponent: <span id="opp-name"></span> (<span id="opp-score">0</span
            >)
          </div>
          <div class="score">Time: <span id="time-left">5</span>s</div>
          <button class="btn" id="start-round" style="margin-left: auto">
            Start Round
          </button>
        </div>
      </div>

      <div class="panel" id="round" style="display: none">
        <div id="prompt" class="message"></div>
        <div id="image-wrap" style="text-align: center; margin: 1rem 0"></div>
        <div id="options" class="options"></div>
        <div id="feedback" class="message" style="display: none"></div>
      </div>
    </div>

    <script type="module">
      let duelId = new URL(location.href).searchParams.get("id") || "";
      const inviteLink = document.getElementById("invite-link");
      const duelInput = document.getElementById("duel-id-input");
      const statusBox = document.getElementById("status");
      const hud = document.getElementById("hud");
      const meName = document.getElementById("me-name");
      const oppName = document.getElementById("opp-name");
      const meScore = document.getElementById("me-score");
      const oppScore = document.getElementById("opp-score");
      const timeLeft = document.getElementById("time-left");
      const promptEl = document.getElementById("prompt");
      const imageWrap = document.getElementById("image-wrap");
      const optionsEl = document.getElementById("options");
      const feedback = document.getElementById("feedback");
      const startBtn = document.getElementById("start-round");
      let pollInterval = null;
      let timerInterval = null;
      let iJoined = false; // whether this client successfully joined as guest
      let evtSource = null;

      const show = (el) => (el.style.display = "block");
      const hide = (el) => (el.style.display = "none");

      async function createDuel() {
        const res = await fetch("/duel/create", {
          method: "POST",
          credentials: "include",
        });
        const data = await res.json();
        if (!data.duelId) return;
        duelId = data.duelId;
        const link = `${location.origin}/duel?id=${duelId}`;
        inviteLink.value = link;
        duelInput.value = duelId;
        show(statusBox);
        statusBox.textContent = `Share this link to invite: ${link}`;
        startPolling();
      }

      async function joinDuel(id) {
        if (!id) return;
        const res = await fetch(`/duel/join/${id}`, {
          method: "POST",
          credentials: "include",
        });
        iJoined = res.ok;
        duelId = id;
        startPolling();
      }

      async function fetchState() {
        if (!duelId) return null;
        const res = await fetch(`/duel/state/${duelId}`, {
          credentials: "include",
        });
        if (!res.ok) return null;
        return await res.json();
      }

      function startPolling() {
        if (pollInterval) clearInterval(pollInterval);
        pollInterval = setInterval(update, 800);
        update();
        startSSE();
      }

      function startSSE() {
        if (!duelId) return;
        if (evtSource) evtSource.close();
        evtSource = new EventSource(`/duel/stream/${duelId}`);
        evtSource.onmessage = (e) => {
          try {
            const state = JSON.parse(e.data);
            renderState(state);
          } catch (_) {}
        };
        evtSource.onerror = () => {
          // keep polling as fallback
        };
      }

      function renderState(state) {
        if (!state) return;
        show(hud);
        const lobby = document.getElementById("lobby");
        // Keep lobby visible for host until a guest joins
        if (iJoined || (state.players && state.players.length === 2)) {
          hide(lobby);
        } else {
          show(lobby);
        }
        const me = state.players.find((p) => p.cookie);
        meName.textContent = state.players[0]?.userName || "";
        oppName.textContent = state.players[1]?.userName || "Waiting";
        meScore.textContent = String(state.players[0]?.score ?? 0);
        oppScore.textContent = String(state.players[1]?.score ?? 0);

        startBtn.disabled = state.status !== "ready";
        if (state.round) {
          show(document.getElementById("round"));
          renderRound(state.round);
        } else if (state.nextAtMs) {
          show(document.getElementById("round"));
          feedback.style.display = "block";
          feedback.textContent = "Next round starting soon...";
          clearInterval(timerInterval);
          const tick = () => {
            const ms = Math.max(0, state.nextAtMs - Date.now());
            timeLeft.textContent = `Next in ${Math.ceil(ms / 1000)}s`;
          };
          tick();
          timerInterval = setInterval(tick, 200);
        }
      }

      function renderRound(round) {
        feedback.style.display = "none";
        promptEl.textContent =
          round.mode === "name-to-image" ? round.prompt : "";
        imageWrap.innerHTML = "";
        if (round.mode === "image-to-name" && round.image) {
          const img = document.createElement("img");
          img.src = round.image;
          img.alt = "Food";
          img.style.maxWidth = "400px";
          img.style.border = "4px solid var(--border-color)";
          imageWrap.appendChild(img);
        }

        optionsEl.innerHTML = "";
        round.options.forEach((opt) => {
          if (round.mode === "image-to-name") {
            const btn = document.createElement("button");
            btn.className = "option-button";
            btn.textContent = opt.label;
            btn.onclick = () => answer(round.id, opt.id, btn);
            optionsEl.appendChild(btn);
          } else {
            const div = document.createElement("div");
            div.className = "image-option";
            div.onclick = () => answer(round.id, opt.id, div);
            const img = document.createElement("img");
            img.src = opt.imageurl;
            img.alt = opt.alt || "";
            div.appendChild(img);
            optionsEl.appendChild(div);
          }
        });

        startTimer(round.expiresAtMs);
      }

      function startTimer(expiresAtMs) {
        clearInterval(timerInterval);
        const tick = () => {
          const ms = Math.max(0, expiresAtMs - Date.now());
          timeLeft.textContent = String(Math.ceil(ms / 1000));
        };
        tick();
        timerInterval = setInterval(tick, 200);
      }

      async function update() {
        const state = await fetchState();
        renderState(state);
      }

      async function startRoundReq() {
        if (!duelId) return;
        await fetch(`/duel/start/${duelId}`, {
          method: "POST",
          credentials: "include",
        });
        update();
      }

      async function answer(roundId, optionId, element) {
        if (!duelId) return;
        const res = await fetch(`/duel/answer/${duelId}`, {
          method: "POST",
          credentials: "include",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ roundId, optionId }),
        });
        const data = await res.json();
        feedback.style.display = "block";
        if (data.correct) {
          feedback.textContent = "Correct!";
          element.style.transform = "translateY(-6px)";
        } else {
          feedback.textContent = "Wrong!";
          element.style.transform = "translateY(6px)";
        }
        // Server closes round immediately; UI waits for SSE/state update
      }

      document.getElementById("create-btn").onclick = createDuel;
      document.getElementById("copy-link").onclick = async () => {
        const v = inviteLink.value.trim();
        if (!v) return;
        try {
          await navigator.clipboard.writeText(v);
          statusBox.style.display = "block";
          statusBox.textContent = "Link copied to clipboard!";
        } catch (_) {}
      };
      document.getElementById("join-btn").onclick = () =>
        joinDuel(duelInput.value.trim());
      startBtn.onclick = startRoundReq;

      if (duelId) {
        joinDuel(duelId);
      }
    </script>
  </body>
</html>
